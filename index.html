<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BTC-USD Scalping 5m</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #signal { font-size: 2rem; }
    #lastDetails { margin-top: 1rem; font-size: 1rem; }
    #info {
      text-align: left;
      margin: 1rem auto;
      width: 80%;
      color: #333;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>BTC-USD (5m) Scalping</h1>
  <div id="signal">Sin señales activas</div>
  <div id="lastDetails"></div>
  <pre id="info"></pre>

  <script>
    async function fetchSignal() {
      const el      = document.getElementById('signal');
      const details = document.getElementById('lastDetails');
      const info    = document.getElementById('info');
      const apiUrl  = window.location.origin + '/api/signal';

      try {
        const res = await fetch(apiUrl);
        console.log('Fetch to', apiUrl, 'Status:', res.status);

        // Si no es 200 OK, mostramos el texto de error
        if (!res.ok) {
          const text = await res.text();
          console.error('API error body:', text);
          el.textContent = `Error API: HTTP ${res.status}`;
          el.style.color = 'gray';
          info.textContent = text;
          details.textContent = '';
          return;
        }

        // Ahora ya es OK, parseamos JSON con seguridad
        let j;
        try {
          j = await res.json();
        } catch(parseErr) {
          const txt = await res.text();
          console.error('JSON parse error, body was:', txt);
          el.textContent = 'Error al leer datos JSON';
          el.style.color = 'gray';
          info.textContent = txt;
          details.textContent = '';
          return;
        }

        console.log('Payload:', j);
        info.textContent = JSON.stringify(j, null, 2);

        // Si la API devolvió su propio error JSON
        if (j.error) {
          el.textContent = 'Error API: ' + j.error;
          el.style.color = 'gray';
          details.textContent = '';
          return;
        }

        // 1) Señal actual
        if (j.signal === 'Mantener') {
          el.textContent = 'Sin señales activas';
          el.style.color = '#666';
        } else {
          el.textContent = `${j.signal} (SMA${j.short}/${j.long})`;
          el.style.color = j.signal === 'Comprar' ? 'green' : 'red';
          alert(`⚡ Señal: ${j.signal}`);
        }

        // 2) Detalles de la última señal efectiva
        if (j.lastSignalTimestamp) {
          const dt = new Date(j.lastSignalTimestamp);
          const dateStr = dt.toLocaleDateString('es-AR', {
            timeZone: 'America/Argentina/Buenos_Aires'
          });
          const timeStr = dt.toLocaleTimeString('es-AR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'America/Argentina/Buenos_Aires'
          });
          const color = j.variation >= 0 ? 'green' : 'red';

          details.innerHTML =
            `<div>Última señal: <strong>${j.lastSignalType}</strong></div>` +
            `<div>Fecha/hora: ${dateStr} ${timeStr} GMT-3</div>` +
            `<div>Variación: <span style="color:${color}">${j.variation.toFixed(2)}%</span></div>`;
        } else {
          details.textContent = '';
        }

      } catch (e) {
        console.error('Fetch error:', e);
        el.textContent = 'Error conexión';
        el.style.color = 'gray';
        info.textContent = 'Fetch error: ' + e.message;
        details.textContent = '';
      }
    }

    window.addEventListener('load', () => {
      fetchSignal();
      setInterval(fetchSignal, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
