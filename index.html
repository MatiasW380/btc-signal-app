<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BTC-USD Scalping 5m</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
      margin: 0;
      transition: background-color 0.5s ease;
    }
    #signal {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    #lastDetails {
      margin-top: 1rem;
      font-size: 1rem;
    }
    #summary {
      margin-top: 2rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    #info {
      text-align: left;
      margin: 1rem auto;
      width: 80%;
      color: #333;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>BTC-USD (5m) Scalping</h1>

  <div id="signal">Sin señales activas</div>
  <div id="lastDetails"></div>
  <div id="summary"></div>
  <pre id="info"></pre>

  <script>
    async function fetchSignal() {
      const el      = document.getElementById('signal');
      const details = document.getElementById('lastDetails');
      const summary = document.getElementById('summary');
      const info    = document.getElementById('info');
      const apiUrl  = window.location.origin + '/api/signal';

      try {
        const res = await fetch(apiUrl);
        console.log('Fetch to', apiUrl, 'Status:', res.status);

        if (!res.ok) {
          const text = await res.text();
          el.textContent = `Error API: HTTP ${res.status}`;
          el.style.color = 'gray';
          document.body.style.backgroundColor = '';
          summary.textContent = '';
          info.textContent = text;
          details.textContent = '';
          return;
        }

        const j = await res.json();
        console.log('Payload:', j);
        info.textContent = JSON.stringify(j, null, 2);

        if (j.error) {
          el.textContent = 'Error API: ' + j.error;
          el.style.color = 'gray';
          document.body.style.backgroundColor = '';
          summary.textContent = '';
          details.textContent = '';
          return;
        }

        // Señal actual
        if (j.signal === 'Mantener') {
          el.textContent = 'Sin señales activas';
          el.style.color = '#666';
          document.body.style.backgroundColor = '';
        } else if (j.signal === 'Comprar') {
          el.textContent = `${j.signal} (SMA${j.short}/${j.long})`;
          el.style.color = 'white';
          document.body.style.backgroundColor = 'green';
          alert(`⚡ Señal: ${j.signal}`);
        } else if (j.signal === 'Vender') {
          el.textContent = `${j.signal} (SMA${j.short}/${j.long})`;
          el.style.color = 'white';
          document.body.style.backgroundColor = 'red';
          alert(`⚡ Señal: ${j.signal}`);
        }

        // Detalles de la última señal efectiva
        if (j.lastSignalTimestamp) {
          const dt = new Date(j.lastSignalTimestamp);
          const dateStr = dt.toLocaleDateString('es-AR', {
            timeZone: 'America/Argentina/Buenos_Aires'
          });
          const timeStr = dt.toLocaleTimeString('es-AR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            timeZone: 'America/Argentina/Buenos_Aires'
          });
          const color = j.variation >= 0 ? 'green' : 'red';

          details.innerHTML =
            `<div>Última señal: <strong>${j.lastSignalType}</strong></div>` +
            `<div>Fecha/hora: ${dateStr} ${timeStr} GMT-3</div>` +
            `<div>Variación: <span style="color:${color}">${j.variation.toFixed(2)}%</span></div>`;
        } else {
          details.textContent = '';
        }

        // Resumen final: short, long y rendimiento mensual
        summary.textContent =
          `Short: ${j.short}, Long: ${j.long} — Rendimiento mes: ${j.ret.toFixed(2)}%`;

      } catch (e) {
        console.error('Fetch error:', e.message);
        el.textContent = 'Error conexión';
        el.style.color = 'gray';
        document.body.style.backgroundColor = '';
        summary.textContent = '';
        info.textContent = 'Fetch error: ' + e.message;
        details.textContent = '';
      }
    }

    window.addEventListener('load', () => {
      fetchSignal();
      setInterval(fetchSignal, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
